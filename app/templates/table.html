{% extends "template_base" %}

{% block table %}

<div id='action_feed'></div>
<div id='action_in'>
    <input type=submit name='check' id='check' value='CHECK' />
    <input type=submit name='call' id='call' value='CALL' />
    <input type=submit name='fold' id='fold' value='FOLD' />
    <label for='amount'>AMOUNT</label>
    <input type=range name='amount' id='amount' />
    <input type=submit name='raise' id='raise' value='RAISE' />
    <input type=submit name='allin' id='allin' value='ALLIN' />
</div>

<div id='board_cards'></div>
<div id='player_cards'></div>
<div id='player_list'></div>
<div id='state'></div>

<div id='tchat'>
    <input type=text name='message' id='message_in' />
    <button name='send' id='send'>Send</button>
    <div id='message_out'>
    </div>
</div>

<script>
    'use strict'

    function makeDiv(text) {
        return "<div>" + text + "</div>";
    }
    function divOfSpam(text_array, id) {
        let html = "<div id='" + id + "'>";
        text_array.forEach(function(s) {
            html.append("<spam>" + s + "</spam>");
        });
        return html + "</div>";
    }
    function updateMoney(player_id, money) {
        $('#' + player_id + ' > spam:nth-child(3)').text(
            money
        );
    }

    const ServerCode = {
        MESSAGE: -6, NEWROUND: 1, NEWTURN: 2, 
        DEALTCARDS: 3, SMALLBLIND: 4, BIGBLIND: 5, 
        PLAYERCHECK: 6, PLAYERCALL: 7, PLAYERFOLD: 8, 
        PLAYERRAISE: 9, PLAYERALLIN: 10,
        PLAYERAMOUNTTOCALL: 11, PUBLICCARDSHOW: 12,
        DECLAREPREMATUREWINNER: 13, DECLAREFINISHEDWINNER: 14,
        ROUNDFINISHED: 15, PLAYERJOINED: 16, PLAYERSETUP: 17
    };
    const ClientCode = {
        MESSAGE: -6, FOLD: -5, CHECK: -4, 
        CALL: -3, RAISE: -2, ALLIN: -1
    };

    const message_in = $("#message_in");
    const message_out = $("#message_out");
    const message_send = $('#send');
    const action_in = $('#action_in');
    const action_feed = $('#action_feed');
    const board_cards = $('#board_cards');
    const player_cards = $('#player_cards');
    const player_list = $('#player_list');
    const state = $('#state');

    const ws = new WebSocket(
        "ws://" + window.location.host + "/tablefeed"
    );
    ws.onopen = function() {
        console.log('Socket Opened');
    };
    ws.onclose = function() {
        console.log('Socket Closed');
    };
    ws.onmessage = function(rcv) {
        let server_sent = JSON.parse(rcv.data);
        let body = server_sent.data;
        let user = $.cookie("player_name");
        switch (server_sent.id) {
            case ServerCode.PLAYERJOINED:
                $.cookie("player_id", body.player_id);
                $.cookie('player_name', body.player_name);
                $.cookie('player_money', body.player_money);
                player_list.append(divOfSpam([
                    body.player_id, body.player_name, 
                ]), toString(data['player_id']));
            case ServerCode.MESSAGE:
                message_out.append(divOfSpam([
                    body['username'], body['message']
                ]));
            case ServerCode.NEWROUND:
                action_feed.append(makeDiv("new round"));
            case ServerCode.NEWTURN:
                action_feed.append(makeDiv(body.turn));
                board_cards.append(body['board_cards']);
            case ServerCode.DEALTCARDS:
                player_cards.text(body['player_cards']);
            case ServerCode.SMALLBLIND:
                updateMoney(
                    body['player_id'], 
                    body['player_money']
                );
                action_feed.append(makeDiv(
                    "player gave small blind of " + 
                    body['stake']
                ));
            case ServerCode.BIGBLIND:
                updateMoney(
                    body['player_id'],
                    body['player_money']
                );
                action_feed.append(makeDiv(
                    body['player_id'] + 
                    ' gave big blind of ' + 
                    body['stake']
                ));
            case ServerCode.PLAYERCHECK:
                action_feed.append(makeDiv(
                    body['player_id'] + ' checks'
                ));
            case ServerCode.PLAYERCALL:
                updateMoney(
                    body['player_id'], 
                    body['player_money']
                );
                action_feed.append(makeDiv(
                    body['player_id'] + ' calls ' + 
                    body['called']
                ));
            case ServerCode.PLAYERFOLD:
                action_feed.append(makeDiv(
                    body['player_id'] + ' folds'
                ));
            case ServerCode.PLAYERRAISE:
                updateMoney(
                    body['player_id'],
                    body['player_money']
                );
                action_feed.append(makeDiv(
                    body['player_id'] + ' raised ' + 
                    body['raised_by']
                ));
            case ServerCode.PLAYERALLIN:
                updateMoney(
                    body['player_id'], 
                    body['player_money']
                );
                action_feed.append(makeDiv(
                    body['player_id'] +
                    ' went all in with ' + 
                    data['allin_stake']
                ));
            case ServerCode.PLAYERAMOUNTTOCALL:
                action_feed.append(makeDiv(
                    body['player_id'] +  ', ' +
                    body['to_call'] + ' to call'
                ));
            case ServerCode.PUBLICCARDSHOW:
                action_feed.append(makeDiv(
                    body['player_id'] + ' has ' +
                    body['player_cards']
                ));
            case ServerCode.DECLAREPREMATUREWINNER:
                updateMoney(
                    body['player_id'],
                    body['player_money']
                );
                action_feed.append(makeDiv(
                    body['player_id'] + ' has won' + 
                    body['won']
                ));
            case ServerCode.DECLAREFINISHEDWINNER:
                updateMoney(
                    body['player_id'],
                    body['player_money']
                );
                action_feed.append(
                    body['player_id'] + ' has won + ' + 
                    body['won'] + ' with ' + 
                    body['hand']
                )
            case ServerCode.ROUNDFINISHED:
                action_feed.append(makeDiv(
                    'Round Finished'
                ));
        }
    };

    $('#check').clck(function() {
        return;
    });
    $('#call').clck(function() {
        return;
    });
    $('#fold').clck(function() {
        return;
    });
    $('#raise').clck(function() {
        return;
    });
    $('#allin').clck(function() {
        return;
    });

    message_send.click(function() {
        ws.send(JSON.stringify({
            id: ClientCode.MESSAGE,
            data: message_in.val()
        }));
    });

</script>

{% endblock %}